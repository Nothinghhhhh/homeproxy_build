# HomeProxy IPK 构建说明

## 🎯 概述

本工具包含完整的Docker构建环境，可以在Windows上为aarch64软路由设备构建HomeProxy IPK包。

## 📋 前置要求

### 必需软件
- **Docker Desktop**: [下载地址](https://www.docker.com/products/docker-desktop)
- **Windows 10/11** (推荐)
- **至少4GB可用内存**
- **至少10GB可用磁盘空间**

### Docker配置建议
1. 分配至少4GB内存给Docker
2. 启用WSL2后端（推荐）
3. 确保网络连接正常（需要下载OpenWrt SDK）

## 🚀 构建方法

### 方法1：一键构建（推荐新手）

**双击运行**：`一键构建IPK.bat`

或者在PowerShell中运行：
```powershell
.\simple-docker-build.ps1
```

### 方法2：完整构建（推荐高级用户）

```powershell
.\docker-build-complete.ps1
```

可选参数：
```powershell
# 指定目标平台
.\docker-build-complete.ps1 -Target "rockchip/armv8" -Subtarget "generic"

# 指定OpenWrt版本
.\docker-build-complete.ps1 -OpenWrtVersion "23.05.2"
```

## 🎛️ 支持的目标平台

| 设备类型 | Target | Subtarget | 说明 |
|---------|--------|-----------|------|
| 小米AX3000T/AX9000等 | `mediatek/filogic` | `generic` | MediaTek MT7986/MT7981 |
| GL.iNet系列 | `mediatek/filogic` | `generic` | MediaTek芯片路由器 |
| 软路由/NAS | `rockchip/armv8` | `generic` | RK3568/RK3588等 |
| 通用ARM64 | `armvirt/64` | `generic` | 虚拟机/容器 |
| 树莓派4 | `bcm27xx/bcm2711` | `generic` | Raspberry Pi 4 |

## ⏱️ 构建时间

- **首次构建**: 15-30分钟（需要下载SDK）
- **后续构建**: 5-10分钟（Docker缓存）

## 📦 输出文件

构建成功后，IPK文件将保存在：
- `ipk-output/` （简单构建）
- `build-output/` （完整构建）

典型输出文件：
```
luci-app-homeproxy_1.0.0-1_all.ipk  (约 50-100KB)
```

## 📝 安装步骤

### 1. 上传IPK文件
使用SSH、SFTP或Web界面将IPK文件上传到软路由设备

### 2. 安装依赖（如需要）
```bash
opkg update
opkg install sing-box firewall4 kmod-nft-tproxy
```

### 3. 安装HomeProxy
```bash
opkg install luci-app-homeproxy_*.ipk
```

### 4. 重启服务
```bash
/etc/init.d/uhttpd restart
```

### 5. 访问Web界面
浏览器访问: `http://路由器IP/cgi-bin/luci/admin/services/homeproxy`

## 🔧 功能特性

合并后的版本包含以下功能：

### ✨ 基础功能
- [x] 支持多种代理协议
- [x] 灵活的路由规则
- [x] DNS分流
- [x] 访问控制

### 🎛️ Clash UI功能（新增）
- [x] **完整的Clash API支持**
- [x] **Web Dashboard访问**
- [x] **可视化节点管理**
- [x] **实时连接监控**
- [x] **规则匹配统计**

### ⚙️ 高级配置
- [x] 自定义外部控制器
- [x] UI主题下载
- [x] 安全密钥设置
- [x] 代理模式切换

## 🛠️ 故障排除

### 构建失败
1. **Docker未启动**: 启动Docker Desktop
2. **网络问题**: 检查网络连接，可能需要代理
3. **磁盘空间不足**: 清理Docker缓存 `docker system prune`
4. **内存不足**: 增加Docker内存分配

### 安装失败
1. **依赖缺失**: 先安装sing-box等依赖
2. **架构不匹配**: 确认目标平台正确
3. **版本冲突**: 卸载旧版本后重装

### 运行问题
1. **无法访问Web界面**: 重启uhttpd服务
2. **Clash API无响应**: 检查端口配置和防火墙
3. **代理不工作**: 检查节点配置和路由规则

## 📚 相关文档

- [OpenWrt官方文档](https://openwrt.org/docs/start)
- [Sing-Box文档](https://sing-box.sagernet.org/)
- [Docker官方文档](https://docs.docker.com/)

## 🤝 技术支持

如遇到问题，请提供以下信息：
1. 设备型号和架构
2. OpenWrt版本
3. 错误日志
4. 构建配置

## 📄 许可证

本项目基于GPL-2.0许可证开源。
