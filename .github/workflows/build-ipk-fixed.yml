name: Build HomeProxy IPK (Fixed)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      target:
        description: 'Target platform'
        required: true
        default: 'mediatek/filogic'
        type: choice
        options:
          - 'mediatek/filogic'
          - 'rockchip/armv8'
          - 'bcm27xx/bcm2711'
          - 'armvirt/64'
      version:
        description: 'OpenWrt version'
        required: true
        default: '23.05.3'

env:
  OPENWRT_VERSION: ${{ github.event.inputs.version || '23.05.3' }}
  TARGET_PLATFORM: ${{ github.event.inputs.target || 'mediatek/filogic' }}

jobs:
  build:
    runs-on: ubuntu-20.04  # 使用Ubuntu 20.04避免依赖问题
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
      
    - name: Setup build environment
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          git \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3 \
          python3-dev \
          python3-distutils \
          python3-setuptools \
          rsync \
          subversion \
          swig \
          time \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev
          
    - name: Download OpenWrt source
      run: |
        git clone --depth 1 --branch v${{ env.OPENWRT_VERSION }} \
          https://github.com/openwrt/openwrt.git openwrt
          
    - name: Update feeds
      working-directory: openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Copy package files
      run: |
        mkdir -p openwrt/package/luci-app-homeproxy
        cp -r Makefile htdocs po root openwrt/package/luci-app-homeproxy/
        
    - name: Configure build
      working-directory: openwrt
      run: |
        make defconfig
        echo "CONFIG_TARGET_$(echo ${{ env.TARGET_PLATFORM }} | tr '/' '_')=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-homeproxy=m" >> .config
        make defconfig
        cat .config | grep luci-app-homeproxy
        
    - name: Build package
      working-directory: openwrt
      run: |
        make package/luci-app-homeproxy/compile V=s
        
    - name: Collect artifacts
      run: |
        mkdir -p artifacts
        find openwrt/bin/ -name "*luci-app-homeproxy*.ipk" -exec cp {} artifacts/ \;
        ls -la artifacts/
        echo "Checking file content:"
        file artifacts/* || true
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: homeproxy-ipk-${{ env.TARGET_PLATFORM }}-${{ env.OPENWRT_VERSION }}
        path: artifacts/*.ipk
        retention-days: 30
        
    - name: Create release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}
        name: "HomeProxy with Clash UI v${{ github.run_number }}"
        body: |
          ## 📦 HomeProxy IPK with Clash UI Integration
          
          ### 🎯 Target Platform: ${{ env.TARGET_PLATFORM }}
          ### 🔧 OpenWrt Version: ${{ env.OPENWRT_VERSION }}
          
          ### ✨ Features
          - ✅ Complete Clash API support
          - ✅ Web Dashboard integration  
          - ✅ Advanced routing rules
          - ✅ DNS filtering
          - ✅ Access control
          
          ### 📋 Installation
          ```bash
          # Upload IPK file to your router and run:
          opkg install luci-app-homeproxy_*.ipk
          /etc/init.d/uhttpd restart
          ```
          
          ### 🌐 Access
          After installation: `http://router-ip/cgi-bin/luci/admin/services/homeproxy`
          
          ### 🛠️ Build Details
          - Build Date: ${{ github.event.head_commit.timestamp }}
          - Commit: ${{ github.sha }}
          - Ubuntu: 20.04 LTS
        files: artifacts/*.ipk
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
